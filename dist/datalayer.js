"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}!function a(s,o,f){function c(t,e){if(!o[t]){if(!s[t]){var r="function"==typeof require&&require;if(!e&&r)return r(t,!0);if(u)return u(t,!0);var n=new Error("Cannot find module '"+t+"'");throw n.code="MODULE_NOT_FOUND",n}var i=o[t]={exports:{}};s[t][0].call(i.exports,function(e){return c(s[t][1][e]||e)},i,i.exports,a,s,o,f)}return o[t].exports}for(var u="function"==typeof require&&require,e=0;e<f.length;e++)c(f[e]);return c}({1:[function(e,t,r){var s={};s.Item=e("./DataLayerItem"),s.utils=e("./DataLayerUtils");var a="datalayer:change",o="datalayer:event",n="datalayer:ready",i="past",f="future",c="all";s.Manager=function(e){this._config=e,this._initialize()},s.Manager.prototype._initialize=function(){var e=this;Array.isArray(e._config.dataLayer)||(e._config.dataLayer=[]),e._dataLayer=e._config.dataLayer,e._state={},e._listeners={},e._augment(),e._processItems();var t=new s.Item({event:n});e._triggerListeners(t)},s.Manager.prototype._updateState=function(e){s.utils.deepMerge(this._state,e.config.data)},s.Manager.prototype._augment=function(){var a=this;a._dataLayer.push=function(e){var n=arguments,i=arguments;if(Object.keys(n).forEach(function(e){var t=n[e],r=new s.Item(t);a._processItem(r),!s.utils.isListenerConfig(t)&&r.valid||delete i[e]}),i[0])return Array.prototype.push.apply(this,i)},a._dataLayer.getState=function(){return JSON.parse(JSON.stringify(a._state))}},s.Manager.prototype._processItems=function(){for(var e=this,t=0;t<e._dataLayer.length;t++){var r=new s.Item(e._dataLayer[t],t);e._processItem(r),!s.utils.isListenerConfig(r.config)&&r.valid||(e._dataLayer.splice(t,1),t--)}},s.Manager.prototype._processItem=function(e){var t=this;if(e.valid){({data:function(e){t._updateState(e),t._triggerListeners(e)},event:function(e){e.config.data&&t._updateState(e),t._triggerListeners(e)},listenerOn:function(e){t._processListenerOn(e)},listenerOff:function(e){t._unregisterListener(e)}})[e.type](e)}else{var r="The following item cannot be handled by the data layer because it does not have a valid format: "+JSON.stringify(e.config);console.error(r)}},s.Manager.prototype._processListenerOn=function(e){var t=e.config.scope;switch(t=t||f){case i:this._triggerListener(e);break;case f:this._registerListener(e);break;case c:this._triggerListener(e),this._registerListener(e)}},s.Manager.prototype._triggerListener=function(e){var t=e.index;if(!(0===t||0===this._dataLayer.length||t>this._dataLayer.length-1))for(var r=t||this._dataLayer.length,n=0;n<r;n++){var i=this._dataLayer[n],a=new s.Item(i,n);this._callListenerHandler(e,a)}},s.Manager.prototype._triggerListeners=function(t){var r=this;r._getTriggeredEvents(t).forEach(function(e){r._listeners[e]&&r._listeners[e].forEach(function(e){r._callListenerHandler(e,t)})})},s.Manager.prototype._callListenerHandler=function(e,t){if(this._isMatching(e,t)){var r=e.config,n=t.config,i=JSON.parse(JSON.stringify(n));r.handler(i)}},s.Manager.prototype._isMatching=function(e,t){var r=e.config,n=t.config,i=!1;return s.utils.isDataConfig(n)?r.on===a&&(i=!0):s.utils.isEventConfig(n)&&(r.on!==o&&r.on!==n.event||(i=!0),n.data&&r.on===a&&(i=!0)),i},s.Manager.prototype._getTriggeredEvents=function(e){var t=[],r=e.config;return s.utils.isDataConfig(r)?t.push(a):s.utils.isEventConfig(r)&&(t.push(r.event),t.push(o),r.data&&t.push(a)),t},s.Manager.prototype._registerListener=function(e){var t=e.config.on;this._isRegisteredListener(e)||(this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(e),console.debug("listener registered on: ",t))},s.Manager.prototype._unregisterListener=function(e){for(var t=this._getListenersMatchingListenerOff(e),r=e.config.off,n=0;n<t.length;n++)-1<t[n]&&(this._listeners[r].splice(t[n],1),console.debug("listener unregistered on: ",r))},s.Manager.prototype._getListenersMatchingListenerOff=function(e){var t=[],r=e.config.off;if(this._listeners[r])for(var n=0;n<this._listeners[r].length;n++){var i=this._listeners[r][n];this._listenerOffMatchesListenerOn(e,i)&&t.push(n)}return t},s.Manager.prototype._listenerOffMatchesListenerOn=function(e,t){for(var r=e.config,n=t.config,i=0;i<Object.keys(r).length;i++){var a=Object.keys(r)[i];if("off"!==a){if(r[a]!==n[a])return!1}else if(r.off!==n.on)return!1}return!0},s.Manager.prototype._isRegisteredListener=function(e){var t=e.config.on;if(this._listeners[t])for(var r=0;r<this._listeners[t].length;r++){var n=this._listeners[t][r];if(this.listenersAreEqual(e,n))return!0}return!1},s.Manager.prototype.listenersAreEqual=function(e,t){var r=e.config,n=t.config;return Object.keys(r).length===Object.keys(n).length&&(Object.keys(r).forEach(function(e){if(r[e]!==n[e])return!1}),!0)},new s.Manager({dataLayer:window.dataLayer}),t.exports=s},{"./DataLayerItem":2,"./DataLayerUtils":3}],2:[function(e,t,r){var s=e("./DataLayerUtils"),o="data",f="event",c="listenerOn",u="listenerOff",n=function(){function a(e,t){_classCallCheck(this,a);var r,n,i=this;i._config=e,i._type=(r=e,s.isDataConfig(r)?n=o:s.isEventConfig(r)?n=f:s.isListenerOnConfig(r)?n=c:s.isListenerOffConfig(r)&&(n=u),n),i._index=t,i._valid=!!i._type}return _createClass(a,[{key:"config",get:function(){return this._config}},{key:"type",get:function(){return this._type}},{key:"valid",get:function(){return this._valid}},{key:"index",get:function(){return this._index}}]),a}();t.exports=n},{"./DataLayerUtils":3}],3:[function(e,t,r){var c={deepMerge:function(t,r){var n={},i=this;i.isObject(t)&&i.isObject(r)&&Object.keys(r).forEach(function(e){i.isObject(r[e])?(t[e]||(n[e]={},Object.assign(t,n)),i.deepMerge(t[e],r[e])):void 0===r[e]?delete t[e]:(n[e]=r[e],Object.assign(t,n))})},isObject:function(e){return e&&"object"===_typeof(e)&&!Array.isArray(e)},isDataConfig:function(e){return c.itemConfigMatchesConstraints(e,{properties:[{key:"data",type:"object",mandatory:!0}],customPropertiesAllowed:!1})},isEventConfig:function(e){return c.itemConfigMatchesConstraints(e,{properties:[{key:"event",type:"string",mandatory:!0},{key:"info",type:"object",mandatory:!1},{key:"data",type:"object",mandatory:!1}],customPropertiesAllowed:!1})},isListenerConfig:function(e){return this.isListenerOnConfig(e)||this.isListenerOffConfig(e)},isListenerOnConfig:function(e){return c.itemConfigMatchesConstraints(e,{properties:[{key:"on",type:"string",mandatory:!0},{key:"handler",type:"function",mandatory:!0},{key:"scope",type:"string",values:["past","future","all"],mandatory:!1},{key:"selector",type:"string",mandatory:!1}],customPropertiesAllowed:!1})},isListenerOffConfig:function(e){return c.itemConfigMatchesConstraints(e,{properties:[{key:"off",type:"string",mandatory:!0},{key:"handler",type:"function",mandatory:!1},{key:"scope",type:"string",values:["past","future","all"],mandatory:!1},{key:"selector",type:"string",mandatory:!1}],customPropertiesAllowed:!1})},itemConfigMatchesConstraints:function(e,t){for(var r=0;r<t.properties.length;r++){var n=t.properties[r].key,i=t.properties[r].type,a=t.properties[r].values,s=t.properties[r].mandatory,o=e[n],f=_typeof(o);if(s){if(!o||f!==i||!c.valueIsAllowed(o,a))return!1}else if(o&&(f!==i||!c.valueIsAllowed(o,a)))return!1}return t.customPropertiesAllowed||!c.itemConfigHasCustomProperties(e,t)},itemConfigHasCustomProperties:function(e,t){var r=Object.keys(e);if(r.length>t.properties.length)return!0;for(var n=0;n<r.length;n++){for(var i=r[n],a=!1,s=0;s<t.properties.length;s++){if(i===t.properties[s].key){a=!0;break}}if(!a)return!0}return!1},valueIsAllowed:function(e,t){if(!t)return!0;for(var r=0;r<t.length;r++){if(e===t[r])return!0}return!1}};t.exports=c},{}]},{},[1]);
//# sourceMappingURL=datalayer.js.map

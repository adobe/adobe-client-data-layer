"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}!function s(a,o,c){function f(t,e){if(!o[t]){if(!a[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(p)return p(t,!0);var r=new Error("Cannot find module '"+t+"'");throw r.code="MODULE_NOT_FOUND",r}var i=o[t]={exports:{}};a[t][0].call(i.exports,function(e){return f(a[t][1][e]||e)},i,i.exports,s,a,o,c)}return o[t].exports}for(var p="function"==typeof require&&require,e=0;e<c.length;e++)f(c[e]);return f}({1:[function(e,t,n){var a={};a.Item=e("./DataLayerItem").item,a.utils=e("./DataLayerUtils"),a.constants=e("./DataLayerConstants"),a.Manager=function(e){this._config=e,this._initialize()},a.Manager.prototype._initialize=function(){var e=this;Array.isArray(e._config.dataLayer)||(e._config.dataLayer=[]),e._dataLayer=e._config.dataLayer,e._state={},e._listeners={},e._augment(),e._processItems();var t=new a.Item({event:a.constants.event.READY});e._triggerListeners(t)},a.Manager.prototype._updateState=function(e){a.utils.deepMerge(this._state,e.config.data)},a.Manager.prototype._augment=function(){var s=this;s._dataLayer.push=function(e){var r=arguments,i=arguments;if(Object.keys(r).forEach(function(e){var t=r[e],n=new a.Item(t);s._processItem(n),n.type!==a.constants.itemType.LISTENER_ON&&n.type!==a.constants.itemType.LISTENER_OFF&&n.valid||delete i[e]}),i[0])return Array.prototype.push.apply(this,i)},s._dataLayer.getState=function(){return JSON.parse(JSON.stringify(s._state))}},a.Manager.prototype._processItems=function(){for(var e=this,t=0;t<e._dataLayer.length;t++){var n=new a.Item(e._dataLayer[t],t);e._processItem(n),n.type!==a.constants.itemType.LISTENER_ON&&n.type!==a.constants.itemType.LISTENER_OFF&&n.valid||(e._dataLayer.splice(t,1),t--)}},a.Manager.prototype._processItem=function(e){var t=this;if(e.valid){({data:function(e){t._updateState(e),t._triggerListeners(e)},event:function(e){e.config.data&&t._updateState(e),t._triggerListeners(e)},listenerOn:function(e){t._processListenerOn(e)},listenerOff:function(e){t._unregisterListener(e)}})[e.type](e)}else{var n="The following item cannot be handled by the data layer because it does not have a valid format: "+JSON.stringify(e.config);console.error(n)}},a.Manager.prototype._processListenerOn=function(e){var t=e.config.scope;switch(t=t||a.constants.listenerScope.FUTURE){case a.constants.listenerScope.PAST:this._triggerListener(e);break;case a.constants.listenerScope.FUTURE:this._registerListener(e);break;case a.constants.listenerScope.ALL:this._triggerListener(e),this._registerListener(e)}},a.Manager.prototype._triggerListener=function(e){var t=e.index;if(!(0===t||0===this._dataLayer.length||t>this._dataLayer.length-1))for(var n=t||this._dataLayer.length,r=0;r<n;r++){var i=this._dataLayer[r],s=new a.Item(i,r);this._callListenerHandler(e,s)}},a.Manager.prototype._triggerListeners=function(t){var n=this;n._getTriggeredEvents(t).forEach(function(e){n._listeners[e]&&n._listeners[e].forEach(function(e){n._callListenerHandler(e,t)})})},a.Manager.prototype._callListenerHandler=function(e,t){if(this._isMatching(e,t)){var n=e.config,r=t.config,i=JSON.parse(JSON.stringify(r));n.handler(i)}},a.Manager.prototype._isMatching=function(e,t){var n=e.config,r=t.config,i=!1;return t.type===a.constants.itemType.DATA?n.on===a.constants.event.CHANGE&&(i=!0):t.type===a.constants.itemType.EVENT&&(n.on!==a.constants.event.EVENT&&n.on!==r.event||(i=!0),r.data&&n.on===a.constants.event.CHANGE&&(i=!0)),i},a.Manager.prototype._getTriggeredEvents=function(e){var t=[],n=e.config;return e.type===a.constants.itemType.DATA?t.push(a.constants.event.CHANGE):e.type===a.constants.itemType.EVENT&&(t.push(n.event),t.push(a.constants.event.EVENT),n.data&&t.push(a.constants.event.CHANGE)),t},a.Manager.prototype._registerListener=function(e){var t=e.config.on;this._isRegisteredListener(e)||(this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(e),console.debug("listener registered on: ",t))},a.Manager.prototype._unregisterListener=function(e){for(var t=this._getListenersMatchingListenerOff(e),n=e.config.off,r=t.length-1;-1<r;r--)-1<t[r]&&(this._listeners[n].splice(t[r],1),console.debug("listener unregistered on: ",n))},a.Manager.prototype._getListenersMatchingListenerOff=function(e){var t=[],n=e.config.off;if(this._listeners[n])for(var r=0;r<this._listeners[n].length;r++){var i=this._listeners[n][r];this._listenerOffMatchesListenerOn(e,i)&&t.push(r)}return t},a.Manager.prototype._listenerOffMatchesListenerOn=function(e,t){for(var n=e.config,r=t.config,i=0;i<Object.keys(n).length;i++){var s=Object.keys(n)[i];if("off"!==s){if(n[s]!==r[s])return!1}else if(n.off!==r.on)return!1}return!0},a.Manager.prototype._isRegisteredListener=function(e){var t=e.config.on;if(this._listeners[t])for(var n=0;n<this._listeners[t].length;n++){var r=this._listeners[t][n];if(this.listenersAreEqual(e,r))return!0}return!1},a.Manager.prototype.listenersAreEqual=function(e,t){var n=e.config,r=t.config;if(Object.keys(n).length!==Object.keys(r).length)return!1;for(var i=Object.keys(n),s=0;s<i.length;s++){var a=i[s];if(n[a]!==r[a])return!1}return!0},new a.Manager({dataLayer:window.dataLayer}),t.exports=a},{"./DataLayerConstants":2,"./DataLayerItem":3,"./DataLayerUtils":4}],2:[function(e,t,n){t.exports={itemType:{DATA:"data",EVENT:"event",LISTENER_ON:"listenerOn",LISTENER_OFF:"listenerOff"},event:{CHANGE:"datalayer:change",EVENT:"datalayer:event",READY:"datalayer:ready"},listenerScope:{PAST:"past",FUTURE:"future",ALL:"all"}}},{}],3:[function(e,t,n){var a={};a.constants=e("./DataLayerConstants");var o={properties:{data:{type:"object"}}},c={properties:{event:{type:"string"},info:{type:"object",optional:!0},data:{type:"object",optional:!0}}},f={properties:{on:{type:"string"},handler:{type:"function"},scope:{type:"string",values:["past","future","all"],optional:!0},selector:{type:"string",optional:!0}}},p={properties:{off:{type:"string"},handler:{type:"function",optional:!0},scope:{type:"string",values:["past","future","all"],optional:!0},selector:{type:"string",optional:!0}}},r=function(){function s(e,t){_classCallCheck(this,s);var n,r,i=this;i._config=e,i._type=(n=e,u.itemConfigMatchesConstraints(n,o)?r=a.constants.itemType.DATA:u.itemConfigMatchesConstraints(n,c)?r=a.constants.itemType.EVENT:u.itemConfigMatchesConstraints(n,f)?r=a.constants.itemType.LISTENER_ON:u.itemConfigMatchesConstraints(n,p)&&(r=a.constants.itemType.LISTENER_OFF),r),i._index=t,i._valid=!!i._type}return _createClass(s,[{key:"config",get:function(){return this._config}},{key:"type",get:function(){return this._type}},{key:"valid",get:function(){return this._valid}},{key:"index",get:function(){return this._index}}]),s}(),u={itemConfigMatchesConstraints:function(e,t){for(var n=Object.keys(t.properties),r=0;r<n.length;r++){var i=n[r],s=t.properties[i].type,a=t.properties[i].values,o=!t.properties[i].optional,c=e[i],f=_typeof(c);if(o){if(!c||f!==s||a&&!a.includes(c))return!1}else if(c&&(f!==s||a&&!a.includes(c)))return!1}return!u.itemConfigHasCustomProperties(e,t)},itemConfigHasCustomProperties:function(e,t){var n=Object.keys(e),r=Object.keys(t.properties);if(n.length>r.length)return!0;for(var i=0;i<n.length;i++){for(var s=n[i],a=!1,o=0;o<r.length;o++){if(s===r[o]){a=!0;break}}if(!a)return!0}return!1}};t.exports={item:r,utils:u}},{"./DataLayerConstants":2}],4:[function(e,t,n){var r={deepMerge:function(t,n){var r={},i=this;i.isObject(t)&&i.isObject(n)&&Object.keys(n).forEach(function(e){i.isObject(n[e])?(t[e]||(r[e]={},Object.assign(t,r)),i.deepMerge(t[e],n[e])):void 0===n[e]?delete t[e]:(r[e]=n[e],Object.assign(t,r))})},isObject:function(e){return e&&"object"===_typeof(e)&&!Array.isArray(e)}};t.exports=r},{}]},{},[1]);
//# sourceMappingURL=datalayer.js.map

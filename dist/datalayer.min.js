!function(){"use strict";var e={},t="datalayer:change",n="datalayer:event",i="datalayer:ready",r="past",s="future",a="all";e.Manager=function(e){this._config=e,this._initialize()},e.Manager.prototype._initialize=function(){Array.isArray(this._config.dataLayer)||(this._config.dataLayer=[]),this._dataLayer=this._config.dataLayer,this._state={},this._listeners=[],this._augment(),this._processItems();var t=new e.Item({event:i},-1);this._triggerListeners(t)},e.Manager.prototype._augment=function(){var t=this;t._dataLayer.push=function(n){var i=arguments,r=arguments;if(Object.keys(i).forEach((function(n){var s=i[n],a=new e.Item(s,-1);t._processItem(a),a.utils.isListenerConfig(s)&&delete r[n]})),r[0])return Array.prototype.push.apply(this,r)},t._dataLayer.getState=function(){return JSON.parse(JSON.stringify(t._state))}},e.Manager.prototype._processItems=function(){for(var t=0;t<this._dataLayer.length;t++){var n=new e.Item(this._dataLayer[t],t);this._processItem(n),n.utils.isListenerConfig(n.getConfig())&&(this._dataLayer.splice(t,1),t--)}},e.Manager.prototype._processItem=function(e){var t=this;if(e.isValid()){({data:function(e){t._updateState(e),t._triggerListeners(e)},event:function(e){e.getConfig().data&&t._updateState(e),t._triggerListeners(e)},listenerOn:function(e){t._processListenerOn(e)},listenerOff:function(e){t._unregisterListener(e)}})[e.getType()](e)}else{var n="The following item cannot be handled by the data layer because it does not have a valid format: "+JSON.stringify(e.getConfig());console.error(n)}},e.Manager.prototype._processListenerOn=function(e){var t=e.getConfig().scope;switch(t||(t=s),t){case r:this._triggerListenerOnPreviousItems(e);break;case s:this._registerListener(e);break;case a:this._triggerListenerOnPreviousItems(e),this._registerListener(e);break;default:console.error("The listener does not have a valid scope: "+t)}},e.Manager.prototype._triggerListeners=function(t){var n=this;n._listeners.forEach((function(i){var r=new e.Item(i,-1);n._triggerListener(r,t)}))},e.Manager.prototype._triggerListenerOnPreviousItems=function(t){var n=t.getIndex();if(!(0===n||0===this._dataLayer.length||n>this._dataLayer.length-1))for(var i=n&&-1!==n?n:this._dataLayer.length,r=0;r<i;r++){var s=this._dataLayer[r],a=new e.Item(s,r);this._triggerListener(t,a)}},e.Manager.prototype._triggerListener=function(e,i){var r=!1,s=e.getConfig(),a=i.getConfig();if(i.utils.isDataConfig(a)?s.on===t&&(r=!0):i.utils.isEventConfig(a)&&(s.on!==n&&s.on!==a.event||(r=!0),a.data&&s.on===t&&(r=!0)),r){var o=JSON.parse(JSON.stringify(i.getConfig()));s.handler(o)}},e.Manager.prototype._registerListener=function(e){var t=e.getConfig();0===this._getRegisteredListeners(t).length&&(this._listeners.push(t),console.debug("listener registered on -",t.on))},e.Manager.prototype._unregisterListener=function(e){var t=e.getConfig(),n=JSON.parse(JSON.stringify(t));n.on=t.off,n.handler=t.handler,delete n.off;for(var i=this._getRegisteredListeners(n),r=0;r<i.length;r++)i[r]>-1&&(this._listeners.splice(i[r],1),console.debug("listener unregistered on -",n.on))},e.Manager.prototype._updateState=function(t){e.utils.deepMerge(this._state,t.getConfig().data)},e.Manager.prototype._getRegisteredListeners=function(e){for(var t=[],n=0;n<this._listeners.length;n++){var i=this._listeners[n];if(e.on===i.on){if(e.handler&&e.handler.toString()!==i.handler.toString())continue;t.push(n)}}return t};var o="data",g="event",f="listenerOn",c="listenerOff";e.Item=function(e,t){var n,i,r=this;r._config=e,r._index=t,r._type=(n=e,r.utils.isDataConfig(n)?i=o:r.utils.isEventConfig(n)?i=g:r.utils.isListenerOnConfig(n)?i=f:r.utils.isListenerOffConfig(n)&&(i=c),i),r._valid=!!r._type},e.Item.prototype.getIndex=function(){return this._index},e.Item.prototype.isValid=function(){return this._valid},e.Item.prototype.getType=function(){return this._type},e.Item.prototype.getConfig=function(){return this._config},e.Item.prototype.utils={isDataConfig:function(e){return!!e&&(1===Object.keys(e).length&&e.data)},isEventConfig:function(e){return!!e&&(1===Object.keys(e).length&&e.event||2===Object.keys(e).length&&e.event&&e.info||2===Object.keys(e).length&&e.event&&e.data||3===Object.keys(e).length&&e.event&&e.info&&e.data)},isListenerConfig:function(e){return this.isListenerOnConfig(e)||this.isListenerOffConfig(e)},isListenerOnConfig:function(e){return!!e&&(2===Object.keys(e).length&&e.on&&e.handler||3===Object.keys(e).length&&e.on&&e.handler&&e.scope||3===Object.keys(e).length&&e.on&&e.handler&&e.selector||4===Object.keys(e).length&&e.on&&e.handler&&e.scope&&e.selector)},isListenerOffConfig:function(e){return!!e&&(1===Object.keys(e).length&&e.off||2===Object.keys(e).length&&e.off&&e.handler||3===Object.keys(e).length&&e.off&&e.handler&&e.scope||3===Object.keys(e).length&&e.off&&e.handler&&e.selector||4===Object.keys(e).length&&e.off&&e.handler&&e.scope&&e.selector)}},e.utils={},e.utils.deepMerge=function(e,t){var n={},i=this;i.isObject(e)&&i.isObject(t)&&Object.keys(t).forEach((function(r){i.isObject(t[r])?(e[r]||(n[r]={},Object.assign(e,n)),i.deepMerge(e[r],t[r])):void 0===t[r]?delete e[r]:(n[r]=t[r],Object.assign(e,n))}))},e.utils.isObject=function(e){return e&&"object"==typeof e&&!Array.isArray(e)},new e.Manager({dataLayer:window.dataLayer}),module.exports=e}();